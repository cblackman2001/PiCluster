- name: Share ssh key to nodes
  hosts: all
  gather_facts: no
  remote_user: "{{ ansible_user }}"
  vars:
    ansible_become_pass: "{{ ansible_ssh_pass }}"
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
    ssh_pubkey_path: "{{ playbook_dir }}/Kubespray_SSH.pub"

  tasks:
    - name: read public key
      slurp:
        src: "{{ ssh_pubkey_path }}"
      register: controller_pubkey_raw
      delegate_to: localhost

    - name: public key as var
      set_fact:
        controller_pubkey: "{{ controller_pubkey_raw.content | b64decode }}"
      delegate_to: localhost

    - name: check .ssh
      file:
        path: "/home/{{ ansible_user }}/.ssh"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0700'

    - name: Install pub key
      authorized_key:
        user: "{{ ansible_user }}"
        key: "{{ controller_pubkey }}"
        state: present